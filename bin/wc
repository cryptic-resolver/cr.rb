#!/usr/bin/env ruby
# coding: utf-8
#  ---------------------------------------------------
#  File          : wc.rb
#  Authors       : ccmywish <ccmywish@qq.com>
#  Created on    : <2021-7-16>
#  Last modified : <2021-12-10>
#
#  This file is used to count the key words in default 
#  sheet: cryptic_computer
#
#  Usage:
#       wc       # Output count in each file
#       wc --all # Only output the total counts 
#  ---------------------------------------------------

require 'tomlrb'

op = ARGV.shift
ALL_MODE = op == "--all" ? true : false


defaults = [
  "~/.cryptic-resolver/cryptic_computer/",
  "~/.cryptic-resolver/cryptic_common/",
  "~/.cryptic-resolver/cryptic_science/",
  "~/.cryptic-resolver/cryptic_economy/",
  "~/.cryptic-resolver/cryptic_medicine/",
].map {|path| File.expand_path(path)}


# A file is like 
#   a.toml
#   d.toml
# So we should first cd into the cryptic_computer sheet
def load_dictionary(file)
  if File.exist? file
    return Tomlrb.load_file file # gem 'tomlrb'
  else
    nil
  end
end

$WordCount = 0

def count_sheet_words(sheet_dir)
  Dir.chdir(sheet_dir)
  wc = 0

  Dir.children(sheet_dir).each do |entry|
    next unless entry.end_with?('.toml')
    dict = load_dictionary(entry)
    count = dict.keys.count
  
    puts "#{entry}: #{count}" unless ALL_MODE
    wc = wc + count
  end

  $WordCount += wc

  unless ALL_MODE
    puts "#{sheet_dir} words: #{wc}\n\n"
  end

end

defaults.each do |s|
  count_sheet_words(s)
end

if ALL_MODE
  print $WordCount # must use print, or rake `` will parse to a new line
end